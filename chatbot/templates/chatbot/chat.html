<head>
    <meta charset="UTF-8" />
    <title>ë¬¸ì„œ ê¸°ë°˜ ì±—ë´‡</title>
    <style>
    * {
        box-sizing: border-box;
    }

    body {
        font-family: sans-serif;
        margin: 0;
        padding: 0;
        display: flex;
        height: 100vh;
    }

    /* ì™¼ìª½: ì—…ë¡œë“œ ë° ì„ íƒ */
    #leftPanel {
        width: 30%;
        background-color: #f9f9f9;
        padding: 20px;
        border-right: 1px solid #ddd;
        overflow-y: auto;
    }

    /* ì˜¤ë¥¸ìª½: ì±—ë´‡ */
    #rightPanel {
        width: 70%;
        display: flex;
        flex-direction: column;
        padding: 20px;
    }

    /* ì±— ì˜ì—­ */
    .chat-container {
        flex: 1;
        overflow-y: auto;
        border: 1px solid #ccc;
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 10px;
    }

    .bubble {
        margin: 10px;
        padding: 10px 15px;
        border-radius: 15px;
        max-width: 70%;
    }

    .bubble.user {
        background-color: #d0eaff;
        text-align: right;
        margin-left: auto;
    }

    .bubble.bot {
        background-color: #eee;
        text-align: left;
        margin-right: auto;
    }

    #messageInput {
        width: 100%;
        padding: 10px;
        margin-top: 5px;
        margin-bottom: 10px;
    }

    button {
        padding: 10px 20px;
    }

    #progressBar {
        width: 100%;
    }
    </style>
</head>
<body>
    <!-- ì™¼ìª½ ì˜ì—­ -->
    <div id="leftPanel">
    <h2>ğŸ“„ ë¬¸ì„œë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”</h2>
    <form id="uploadForm" enctype="multipart/form-data">
        <input type="file" id="fileInput" name="file" required />
        <button type="submit">ì—…ë¡œë“œ</button>
    </form>

    <div id="loadingSection" style="display:none; margin-top: 20px;">
        <p>ğŸ”„ ì—…ë¡œë“œ ì¤‘... ë²¡í„°í™” ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤.</p>
        <progress id="progressBar" value="0" max="100"></progress>
    </div>

    <div id="docSelectSection" style="margin-top: 20px;">
        <h3>ğŸ“‚ ì—…ë¡œë“œëœ ë¬¸ì„œ ì„ íƒ</h3>
        <select id="fileSelector" style="width: 100%;">
        <option disabled selected>ë¬¸ì„œë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
        </select>
    </div>
    </div>

    <!-- ì˜¤ë¥¸ìª½ ì˜ì—­ -->
    <div id="rightPanel">
    <h2>ğŸ¤– ë¬¸ì„œ ê¸°ë°˜ ì±—ë´‡</h2>
    <div id="chatSection" style="flex: 1;">
        <div id="chatArea" class="chat-container"></div>
        <form id="chatForm">
    <div style="display: flex; gap: 10px; align-items: center; width: 100%;">
    <textarea 
    id="messageInput" 
    rows="2" 
    style="flex: 1; resize: none; padding: 10px; font-size: 14px;" 
    placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš” (Enter ë˜ëŠ” Ctrl+Enterë¡œ ì „ì†¡)"
    ></textarea>

    <button 
    type="submit" 
    style="
        padding: 10px 18px;
        font-size: 14px;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
    "
    >
    ì§ˆë¬¸
    </button>
</div>
</form>
    </div>
    </div>

    <script>
    const uploadForm = document.getElementById("uploadForm");
    const loadingSection = document.getElementById("loadingSection");
    const progressBar = document.getElementById("progressBar");
    const chatArea = document.getElementById("chatArea");
    const fileSelector = document.getElementById("fileSelector");
    const messageInput = document.getElementById("messageInput");

    let currentFilePath = "sample.txt";

    // íƒ€ì´í•‘ ì• ë‹ˆë©”ì´ì…˜ í•¨ìˆ˜
    async function typeTextEffect(element, text, speed = 30) {
        element.textContent = "";
        for (let i = 0; i < text.length; i++) {
        element.textContent += text[i];
        await new Promise(resolve => setTimeout(resolve, speed));
        }
    }

    uploadForm.addEventListener("submit", async function (e) {
        e.preventDefault();
        const file = document.getElementById("fileInput").files[0];
        if (!file) return alert("íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");

        uploadForm.style.display = "none";
        loadingSection.style.display = "block";
        progressBar.value = 0;

        let progress = 0;
        const interval = setInterval(() => {
        if (progress < 90) {
            progress += 10;
            progressBar.value = progress;
        }
        }, 400);

        const formData = new FormData();
        formData.append("file", file);

        const response = await fetch("/upload/", { method: "POST", body: formData });
        const result = await response.json();

        clearInterval(interval);
        progressBar.value = 100;

        if (result.success) {
        currentFilePath = result.file_path;
        await loadFileList();
        } else {
        alert("ì—…ë¡œë“œ ì‹¤íŒ¨: " + result.message);
        }

        loadingSection.style.display = "none";
        uploadForm.style.display = "block";
    });

    async function loadFileList() {
        const res = await fetch("/list_files/");
        const data = await res.json();

        fileSelector.innerHTML = '<option disabled selected>ê¸°ì¡´ì— ì˜¬ë¦° ë¬¸ì„œë“¤</option>';
        data.files.forEach(file => {
        const option = document.createElement("option");
        option.value = file;
        option.text = file;
        fileSelector.appendChild(option);
        });
    }

    fileSelector.addEventListener("change", function () {
        currentFilePath = "temp/" + this.value;
    });

    document.getElementById("chatForm").addEventListener("submit", async function (e) {
        e.preventDefault();

        const message = messageInput.value;
        if (!message.trim()) return;

     // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶œë ¥
    const userDiv = document.createElement("div");
    userDiv.className = "bubble user";
    userDiv.textContent = `ğŸ‘¤: ${message}`;
    chatArea.appendChild(userDiv);

    // ë¡œë”© ë©”ì‹œì§€ ì¤€ë¹„
    const botDiv = document.createElement("div");
    botDiv.className = "bubble bot";
    botDiv.id = "loadingBubble";
    botDiv.textContent = "ğŸ¤–: ë‹µë³€ì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...";
    chatArea.appendChild(botDiv);

    messageInput.value = "";
    chatArea.scrollTop = chatArea.scrollHeight;

    // ì„œë²„ ìš”ì²­
    const res = await fetch("/ask/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message, file_path: currentFilePath })
    });

    const data = await res.json();
    const answer = data.answer;

    // ê¸°ì¡´ ë¡œë”© ë©”ì‹œì§€ ì œê±° í›„ ìƒˆ div ì¶”ê°€
    botDiv.remove();

    const botAnswerDiv = document.createElement("div");
    botAnswerDiv.className = "bubble bot";
    chatArea.appendChild(botAnswerDiv);

    // âœ… íƒ€ì´í•‘ ì• ë‹ˆë©”ì´ì…˜ ì ìš©
    await typeTextEffect(botAnswerDiv, "ğŸ¤–: " + answer);

    chatArea.scrollTop = chatArea.scrollHeight;
    });

  // Ctrl+Enter ë˜ëŠ” Enterë¡œ ì „ì†¡
    messageInput.addEventListener("keydown", function (e) {
    if (e.key === "Enter" && (e.ctrlKey || !e.shiftKey)) {
        e.preventDefault();
        document.getElementById("chatForm").dispatchEvent(new Event("submit"));
    }
    });

    window.onload = loadFileList;
    </script>
</body>
</html>
