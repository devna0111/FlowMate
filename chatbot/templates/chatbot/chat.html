<head>
    <meta charset="UTF-8" />
    <title>문서 기반 챗봇</title>
    <style>
    * { box-sizing: border-box; }
    body {
        font-family: sans-serif;
        margin: 0; padding: 0; display: flex; height: 100vh;
    }
    #leftPanel {
        width: 30%; background-color: #f9f9f9; padding: 20px;
        border-right: 1px solid #ddd; overflow-y: auto;
    }
    #rightPanel {
        width: 70%; display: flex; flex-direction: column; padding: 20px;
    }
    .chat-container {
        flex: 1; overflow-y: auto; border: 1px solid #ccc; padding: 10px;
        border-radius: 8px; margin-bottom: 10px; background: #fff;
    }
    .bubble {
        margin: 10px; padding: 10px 15px; border-radius: 15px; max-width: 70%;
        word-break: break-word;
    }
    .bubble.user {
        background-color: #d0eaff; text-align: right; margin-left: auto;
    }
    .bubble.bot {
        background-color: #eee; text-align: left; margin-right: auto;
    }
    #messageInput {
        width: 100%; padding: 10px; margin-top: 5px; margin-bottom: 10px;
    }
    button { padding: 10px 20px; }
    #progressBar { width: 100%; }
    #fileSelector option[selected] { font-weight: bold; }
    .list-section { margin-top: 24px; }
    .file-list, .generated-list {
        width: 100%;
        margin-top: 8px;
        border: 1px solid #ddd;
        border-radius: 6px;
        background: #fff;
        max-height: 140px;
        overflow-y: auto;
        padding: 0;
    }
    .file-list li, .generated-list li {
        list-style: none;
        padding: 7px 10px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        font-size: 15px;
    }
    .file-list li.selected {
        background: #e6f3ff;
        font-weight: bold;
    }
    .generated-list li {
        color: #2a6b9b;
    }
    .generated-list li:last-child, .file-list li:last-child { border-bottom: none; }
    .download-btn {
        margin-left: 10px;
        padding: 3px 12px;
        background: #4095e5;
        color: #fff;
        border: none;
        border-radius: 5px;
        font-size: 13px;
        cursor: pointer;
    }
    /* 마크다운 내용 영역 스타일 */
    .markdown-content h1, .markdown-content h2, .markdown-content h3 { margin-top: 1.2em; }
    .markdown-content ul, .markdown-content ol { margin-left: 1.2em; }
    .markdown-content table { border-collapse: collapse; margin: 12px 0; width: 100%; }
    .markdown-content th, .markdown-content td { border: 1px solid #bbb; padding: 4px 8px; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <!-- 왼쪽 영역 -->
    <div id="leftPanel">
        <h2>📄 문서 업로드</h2>
        <form id="uploadForm" enctype="multipart/form-data">
            <input type="file" id="fileInput" name="file" required />
            <button type="submit">업로드</button>
        </form>
        <div id="loadingSection" style="display:none; margin-top: 20px;">
            <p>🔄 업로드 중... 벡터화 처리 중입니다.</p>
            <progress id="progressBar" value="0" max="100"></progress>
        </div>
        <!-- 업로드 파일 리스트 -->
        <div class="list-section">
            <h3>📂 업로드한 문서</h3>
            <ul id="uploadedFileList" class="file-list"></ul>
        </div>
        <!-- 생성파일 리스트 -->
        <div class="list-section">
            <h3>📝 생성된 보고서/발표자료</h3>
            <ul id="generatedFileList" class="generated-list"></ul>
        </div>
    </div>

    <!-- 오른쪽 영역 -->
    <div id="rightPanel">
        <h2>🤖 문서 기반 챗봇</h2>
        <div id="chatSection" style="flex: 1;">
            <div id="chatArea" class="chat-container"></div>
            <form id="chatForm">
                <div style="display: flex; gap: 10px; align-items: center; width: 100%;">
                    <textarea 
                        id="messageInput" 
                        rows="2" 
                        style="flex: 1; resize: none; padding: 10px; font-size: 14px;" 
                        placeholder="질문을 입력하세요 (Enter 또는 Ctrl+Enter로 전송)"
                    ></textarea>
                    <button 
                        type="submit" 
                        style="padding: 10px 18px; font-size: 14px; background-color: #4CAF50; color: white; border: none; border-radius: 6px; cursor: pointer;">
                        질문
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
    const uploadForm = document.getElementById("uploadForm");
    const loadingSection = document.getElementById("loadingSection");
    const progressBar = document.getElementById("progressBar");
    const chatArea = document.getElementById("chatArea");
    const uploadedFileList = document.getElementById("uploadedFileList");
    const generatedFileList = document.getElementById("generatedFileList");
    const messageInput = document.getElementById("messageInput");

    let currentFilePath = "sample.txt";

    // 파일 업로드
    uploadForm.addEventListener("submit", async function (e) {
        e.preventDefault();
        const file = document.getElementById("fileInput").files[0];
        if (!file) return alert("파일을 선택해주세요.");

        uploadForm.style.display = "none";
        loadingSection.style.display = "block";
        progressBar.value = 0;
        let progress = 0;
        const interval = setInterval(() => {
            if (progress < 90) {
                progress += 10;
                progressBar.value = progress;
            }
        }, 400);

        const formData = new FormData();
        formData.append("file", file);

        const response = await fetch("/upload/", { method: "POST", body: formData });
        const result = await response.json();

        clearInterval(interval);
        progressBar.value = 100;

        if (result.success) {
            currentFilePath = result.file_path;
            await loadUploadedFileList();
        } else {
            alert("업로드 실패: " + result.message);
        }
        loadingSection.style.display = "none";
        uploadForm.style.display = "block";
    });

    // 업로드된 파일 리스트 로딩
    async function loadUploadedFileList() {
        const res = await fetch("/list_files/");
        const data = await res.json();
        uploadedFileList.innerHTML = "";
        data.files.forEach(file => {
            const li = document.createElement("li");
            li.textContent = file;
            li.onclick = () => {
                // 파일 선택
                Array.from(uploadedFileList.children).forEach(c => c.classList.remove("selected"));
                li.classList.add("selected");
                currentFilePath = "temp/" + file;
            };
            // 첫 파일 선택 유지
            if ("temp/" + file === currentFilePath) li.classList.add("selected");
            uploadedFileList.appendChild(li);
        });
    }

    // 생성된 파일 리스트 로딩 (보고서/발표자료)
    async function loadGeneratedFileList() {
        const res = await fetch("/list_generated_files/");
        const data = await res.json();
        generatedFileList.innerHTML = "";
        data.files.forEach(file => {
            const li = document.createElement("li");
            li.textContent = file;
            // 다운로드 버튼 생성
            const btn = document.createElement("button");
            btn.className = "download-btn";
            btn.innerText = "다운로드";
            btn.onclick = (e) => {
                e.stopPropagation();
                // /download_report/?filename=xxx로 다운로드
                window.open(`/download_report/?filename=${encodeURIComponent(file)}`);
            };
            li.appendChild(btn);
            generatedFileList.appendChild(li);
        });
    }

    // 채팅 기능
    document.getElementById("chatForm").addEventListener("submit", async function (e) {
        e.preventDefault();

        const message = messageInput.value.trim();
        if (!message) return;

        // 사용자 메시지 출력
        const userDiv = document.createElement("div");
        userDiv.className = "bubble user";
        userDiv.textContent = `👤: ${message}`;
        chatArea.appendChild(userDiv);

        // 로딩 메시지 준비
        const botDiv = document.createElement("div");
        botDiv.className = "bubble bot";
        botDiv.id = "loadingBubble";
        botDiv.textContent = "🤖: 답변을 생성 중입니다...";
        chatArea.appendChild(botDiv);

        messageInput.value = "";
        chatArea.scrollTop = chatArea.scrollHeight;

        // 서버 요청
        const res = await fetch("/ask/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message, file_path: currentFilePath })
        });

        const contentType = res.headers.get('content-type');
        botDiv.remove();

        // (1) 보고서/발표자료 생성 응답: 마크다운 + 파일 다운로드
        if (contentType && contentType.includes("application/json")) {
            const data = await res.json();

            if (data.report_markdown) {
                // 마크다운 → HTML 변환
                const htmlContent = marked.parse(data.report_markdown);

                const reportDiv = document.createElement("div");
                reportDiv.className = "bubble bot";
                reportDiv.innerHTML = `
                    <div class="markdown-content" style="margin-bottom:12px; max-width: 550px;">${htmlContent}</div>
                    <a href="${data.report_file_url}" download
                        style="display:inline-block;padding:8px 18px;background:#4095e5;color:#fff;border-radius:6px;text-decoration:none;">
                        📄 생성 파일 다운로드
                    </a>
                `;
                chatArea.appendChild(reportDiv);
                chatArea.scrollTop = chatArea.scrollHeight;

                // 생성 파일 리스트 갱신
                await loadGeneratedFileList();
                return;
            }

            // (2) 일반 답변
            const botAnswerDiv = document.createElement("div");
            botAnswerDiv.className = "bubble bot";
            chatArea.appendChild(botAnswerDiv);
            await typeTextEffect(botAnswerDiv, "🤖: " + (data.answer ?? ""));
            chatArea.scrollTop = chatArea.scrollHeight;
            return;
        }
    });

    // Ctrl+Enter 또는 Enter로 전송
    messageInput.addEventListener("keydown", function (e) {
        if (e.key === "Enter" && (e.ctrlKey || !e.shiftKey)) {
            e.preventDefault();
            document.getElementById("chatForm").dispatchEvent(new Event("submit"));
        }
    });

    // 최초 로딩 시 두 리스트 모두 불러오기
    window.onload = async () => {
        await loadUploadedFileList();
        await loadGeneratedFileList();
    };
    </script>
</body>
